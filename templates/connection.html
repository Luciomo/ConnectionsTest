{% extends "base.html" %}

{% block title %}Teste de Conex√£o - VerificaZap{% endblock %}

{% block header %}
    <h1>Teste de Conex√£o üöÄ</h1>
    <p>Verifique a qualidade da <strong>sua</strong> conex√£o com este servidor.</p>
{% endblock %}

{% block content %}
    <style>
        .value {
            font-size: 2rem;
            font-weight: bold;
            color: var(--primary-color);
            display: block;
            margin: 10px 0;
        }
    </style>
    
    <div class="card">
        <div style="text-align: center; margin-bottom: 20px;">
            <p><strong>Seu IP P√∫blico:</strong> <span id="client-ip">Carregando...</span></p>
        </div>

        <div class="conn-grid">
            <div class="conn-item">
                <h3>Lat√™ncia (Ping)</h3>
                <span class="value" id="latency-value">--</span> 
                <span style="font-size: 0.9em; color: #666;">ms</span>
            </div>
            <div class="conn-item">
                <h3>Jitter</h3>
                <span class="value" id="jitter-value">--</span> 
                <span style="font-size: 0.9em; color: #666;">ms</span>
            </div>
        </div>

        <div id="status-msg" style="margin-top: 20px; color: #666; font-style: italic; text-align: center; min-height: 1.5em;">
            Clique no bot√£o para iniciar.
        </div>

        <div style="text-align: center; margin-top: 20px;">
            <button onclick="iniciarTesteCliente()" id="btn-start" style="padding: 12px 25px; font-size: 1.1em;">
                ‚ñ∂Ô∏è Iniciar Teste
            </button>
        </div>
    </div>

    <script>
        fetch('https://api64.ipify.org?format=json')
            .then(response => response.json())
            .then(data => {
                const ipSpan = document.getElementById('client-ip');
                if (ipSpan) ipSpan.textContent = data.ip;
            })
            .catch(() => {
                document.getElementById('client-ip').textContent = "Indispon√≠vel";
            });
        
       async function iniciarTesteCliente() {
            const btn = document.getElementById('btn-start');
            const status = document.getElementById('status-msg');
            const latDisplay = document.getElementById('latency-value');
            const jitDisplay = document.getElementById('jitter-value');
            
            btn.disabled = true;
            btn.style.opacity = "0.7";
            status.textContent = "Testando lat√™ncia...";
            latDisplay.textContent = "...";
            jitDisplay.textContent = "...";

            let latencies = [];
            const iterations = 10;

            // Realiza pings sequenciais
            for(let i=0; i < iterations; i++) {
                const start = performance.now();
                try {
                    // Adiciona timestamp para evitar cache
                    await fetch(`/api/ping_pong?t=${Date.now()}`);
                    const end = performance.now();
                    const duration = end - start;
                    latencies.push(duration);
                    
                    status.textContent = `Enviando pacote ${i+1}/${iterations}... (${duration.toFixed(0)}ms)`;
                } catch(e) {
                    console.error(e);
                }
                // Pequena pausa entre requisi√ß√µes para n√£o floodar
                await new Promise(r => setTimeout(r, 200));
            }

            if(latencies.length > 0) {
                // C√°lculo da M√©dia
                const avg = latencies.reduce((a,b)=>a+b,0) / latencies.length;
                
                // C√°lculo do Jitter (M√©dia das diferen√ßas absolutas entre pings consecutivos)
                let jitterSum = 0;
                for (let i = 0; i < latencies.length - 1; i++) {
                    jitterSum += Math.abs(latencies[i] - latencies[i+1]);
                }
                const jitter = latencies.length > 1 ? jitterSum / (latencies.length - 1) : 0;

                latDisplay.textContent = avg.toFixed(1);
                jitDisplay.textContent = jitter.toFixed(1);
                
                status.innerHTML = `‚úÖ Teste conclu√≠do com sucesso!`;
            } else {
                latDisplay.textContent = "Erro";
                jitDisplay.textContent = "Erro";
                status.textContent = "‚ùå N√£o foi poss√≠vel conectar ao servidor.";
            }

            btn.disabled = false;
            btn.style.opacity = "1";
            btn.textContent = "üîÑ Refazer Teste";
        }
    </script>

    <a href="{{ url_for('index') }}" class="back-link">‚Üê Voltar para Home</a>
{% endblock %}