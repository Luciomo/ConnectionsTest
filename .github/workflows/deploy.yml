# Deploy to EC2
name: Deploy to EC2

on:
  push:
    branches:
      - main

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
      - name: Deploy to EC2 via SSH
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: 18.223.29.225
          username: ec2-user
          key: ${{ secrets.EC2_SSH_KEY }}
          port: 22
          script: |
            # Interrompe a execu√ß√£o imediatamente se algum comando falhar
            set -e
            
            # Garante que a pasta base existe
            mkdir -p /home/ec2-user/app
            cd /home/ec2-user/app
            
            # 1. Verifica√ß√£o de Integridade (Self-Healing)
            # Se a pasta existe mas n√£o tem a pasta .git, ela est√° corrompida.
            if [ -d "ConnectionsTest" ] && [ ! -d "ConnectionsTest/.git" ]; then
              echo "‚ö†Ô∏è Pasta encontrada sem .git. Recriando..."
              cp ConnectionsTest/.env .env.backup 2>/dev/null || true
              rm -rf ConnectionsTest
            fi

            # 2. Clone (se necess√°rio)
            if [ ! -d "ConnectionsTest" ]; then
              echo "üì• Clonando reposit√≥rio..."
              git clone https://github.com/Luciomo/ConnectionsTest.git
              
              # Restaura o arquivo .env se houver backup
              if [ -f ".env.backup" ]; then
                mv .env.backup ConnectionsTest/.env
              fi
            fi
            
            cd ConnectionsTest
            
            # 3. Corre√ß√£o For√ßada do Remote
            # Garante que 'origin' existe e aponta para o lugar certo
            if ! git remote | grep -q "^origin$"; then
                git remote add origin https://github.com/Luciomo/ConnectionsTest.git
            else
                git remote set-url origin https://github.com/Luciomo/ConnectionsTest.git
            fi
            
            # 4. Atualiza√ß√£o Segura (Fetch + Reset)
            git fetch origin
            git reset --hard origin/main
            
            # Instala depend√™ncias do sistema operacional
            sudo dnf install -y python3 python3-pip git whois traceroute iputils libcap
            
            # Recria o ambiente virtual se ele n√£o existir (necess√°rio ap√≥s um novo clone)
            if [ ! -d "venv" ]; then
              echo "üêç Criando ambiente virtual..."
              python3 -m venv venv
            fi
            
            # Atualiza depend√™ncias e reinicia o servi√ßo
            source venv/bin/activate
            pip install -r requirements.txt
            
            # Garante permiss√µes para o Python abrir sockets raw (ping)
            sudo setcap cap_net_raw+ep /home/ec2-user/app/ConnectionsTest/venv/bin/python3
            
            sudo systemctl restart connections-test