{% extends "base.html" %}

{% block title %}Teste de Conex√£o - VerificaZap{% endblock %}

{% block header %}
    <h1>Teste de Conex√£o üöÄ</h1>
    <p>Lat√™ncia, Jitter e Velocidade de Internet.</p>
{% endblock %}

{% block content %}
    <style>
        .spinner-btn {
            display: inline-block;
            width: 12px;
            height: 12px;
            border: 2px solid rgba(255,255,255,0.3);
            border-radius: 50%;
            border-top-color: #fff;
            animation: spin 1s ease-in-out infinite;
            margin-right: 8px;
        }
        @keyframes spin { to { transform: rotate(360deg); } }
    </style>
    <script>
        fetch('https://api64.ipify.org?format=json')
            .then(response => response.json())
            .then(data => {
                const urlInput = document.getElementById('target-ip');
                if (urlInput) {
                    urlInput.value = data.ip;
                    document.getElementById('btn-submit').disabled = false;
                }
            })
            .catch(() => console.log("Erro ao obter IP"));
        
       async function iniciarTesteCliente() {
            const btn = document.querySelector('button[onclick="iniciarTesteCliente()"]');
            const status = document.getElementById('status-msg');
            const valDisplay = document.getElementById('latency-value');
            
            btn.disabled = true;
            btn.style.opacity = "0.7";
            status.textContent = "Testando lat√™ncia...";
            valDisplay.textContent = "...";

            let latencies = [];
            // Realiza 10 pings
            for(let i=0; i<10; i++) {
                const start = performance.now();
                try {
                    // Adiciona timestamp para evitar cache
                    await fetch(`/api/ping_pong?t=${Date.now()}`);
                    const end = performance.now();
                    latencies.push(end - start);
                } catch(e) {
                    console.error(e);
                }
                // Pequena pausa entre requisi√ß√µes
                await new Promise(r => setTimeout(r, 100));
            }

            if(latencies.length > 0) {
                const avg = latencies.reduce((a,b)=>a+b,0)/latencies.length;
                valDisplay.textContent = avg.toFixed(0);
                status.textContent = `M√©dia calculada com base em ${latencies.length} requisi√ß√µes.`;
            } else {
                valDisplay.textContent = "Erro";
                status.textContent = "N√£o foi poss√≠vel conectar ao servidor.";
            }

            btn.disabled = false;
            btn.style.opacity = "1";
        }

        document.addEventListener('DOMContentLoaded', function() {
            const form = document.querySelector('form[action="{{ url_for("check_connection") }}"]');
            if(form) {
                form.addEventListener('submit', function(e) {
                    e.stopImmediatePropagation(); // Evita o overlay global
                    const btn = document.getElementById('btn-submit');
                    btn.disabled = true;
                    btn.innerHTML = '<span class="spinner-btn"></span> Testando...';
                });
            }
        });
    </script>

    <hr style="margin: 30px 0; border: 0; border-top: 1px solid #eee;">
    
    <form action="{{ url_for('check_connection') }}" method="POST">
        <input type="hidden" name="url" id="target-ip">
        <button type="submit" id="btn-submit" disabled>Iniciar Teste</button>
    </form>
    <p style="font-size: 0.8em; color: #999; margin-top: 5px;">‚ö†Ô∏è O teste de velocidade do servidor pode levar at√© 30 segundos.</p>
    <a href="{{ url_for('index') }}" class="back-link">‚Üê Voltar para Home</a>
{% endblock %}