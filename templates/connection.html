{% extends "base.html" %}

{% block title %}Teste de Conex√£o{% endblock %}

{% block header %}
    <h1>Teste de Conex√£o üöÄ</h1>
    <p>Verifique a qualidade da <strong>sua</strong> conex√£o com a Internet.</p>
{% endblock %}

{% block content %}
    <style>
        .value {
            font-size: 2rem;
            font-weight: bold;
            color: var(--primary-color);
            display: block;
            margin: 10px 0;
        }
    </style>
    
    <div class="card">
        <div style="text-align: center; margin-bottom: 20px;">
            <p><strong>Seu IP P√∫blico:</strong> <span id="client-ip">Carregando...</span></p>
        </div>

        <div class="conn-grid">
            <div class="conn-item">
                <h3>Lat√™ncia (Ping)</h3>
                <span class="value" id="latency-value">--</span> 
                <span style="font-size: 0.9em; color: #666;">ms</span>
            </div>
            <div class="conn-item">
                <h3>Jitter</h3>
                <span class="value" id="jitter-value">--</span> 
                <span style="font-size: 0.9em; color: #666;">ms</span>
            </div>
            <div class="conn-item">
                <h3>Download</h3>
                <span class="value" id="download-value">--</span> 
                <span style="font-size: 0.9em; color: #666;">Mbps</span>
            </div>
            <div class="conn-item">
                <h3>Upload</h3>
                <span class="value" id="upload-value">--</span> 
                <span style="font-size: 0.9em; color: #666;">Mbps</span>
            </div>
        </div>

        <div id="status-msg" style="margin-top: 20px; color: #666; font-style: italic; text-align: center; min-height: 1.5em;">
            Clique no bot√£o para iniciar.
        </div>

        <div style="text-align: center; margin-top: 20px;">
            <button onclick="iniciarTesteCliente()" id="btn-start" style="padding: 12px 25px; font-size: 1.1em;">
                ‚ñ∂Ô∏è Iniciar Teste
            </button>
        </div>
    </div>

    <script>
        fetch('https://api64.ipify.org?format=json')
            .then(response => response.json())
            .then(data => {
                const ipSpan = document.getElementById('client-ip');
                if (ipSpan) ipSpan.textContent = data.ip;
            })
            .catch(() => {
                document.getElementById('client-ip').textContent = "Indispon√≠vel";
            });
        
       async function iniciarTesteCliente() {
            const btn = document.getElementById('btn-start');
            const status = document.getElementById('status-msg');
            const latDisplay = document.getElementById('latency-value');
            const jitDisplay = document.getElementById('jitter-value');
            const dlDisplay = document.getElementById('download-value');
            const ulDisplay = document.getElementById('upload-value');
            
            btn.disabled = true;
            btn.style.opacity = "0.7";
            status.textContent = "Testando lat√™ncia...";
            latDisplay.textContent = "...";
            jitDisplay.textContent = "...";
            dlDisplay.textContent = "--";
            ulDisplay.textContent = "--";
            
            // Reseta as cores para o padr√£o ao iniciar um novo teste
            dlDisplay.style.color = "";
            ulDisplay.style.color = "";

            let latencies = [];
            const iterations = 10;

            // Realiza pings sequenciais
            for(let i=0; i < iterations; i++) {
                const start = performance.now();
                try {
                    // Adiciona timestamp para evitar cache
                    await fetch(`/api/ping_pong?t=${Date.now()}`);
                    const end = performance.now();
                    const duration = end - start;
                    latencies.push(duration);
                    
                    status.textContent = `Enviando pacote ${i+1}/${iterations}... (${duration.toFixed(0)}ms)`;
                } catch(e) {
                    console.error(e);
                }
                // Pequena pausa entre requisi√ß√µes para n√£o floodar
                await new Promise(r => setTimeout(r, 200));
            }

            if(latencies.length > 0) {
                // C√°lculo da M√©dia
                const avg = latencies.reduce((a,b)=>a+b,0) / latencies.length;
                
                // C√°lculo do Jitter (M√©dia das diferen√ßas absolutas entre pings consecutivos)
                let jitterSum = 0;
                for (let i = 0; i < latencies.length - 1; i++) {
                    jitterSum += Math.abs(latencies[i] - latencies[i+1]);
                }
                const jitter = latencies.length > 1 ? jitterSum / (latencies.length - 1) : 0;

                latDisplay.textContent = avg.toFixed(1);
                jitDisplay.textContent = jitter.toFixed(1);
                
                // --- Teste de Download ---
                status.textContent = "Testando Download (5MB)...";
                dlDisplay.textContent = "...";
                try {
                    const dlStart = performance.now();
                    const response = await fetch('/api/speedtest/download');
                    const blob = await response.blob();
                    const dlEnd = performance.now();
                    
                    const dlDurationSec = (dlEnd - dlStart) / 1000;
                    const dlSizeBits = blob.size * 8;
                    const dlSpeedMbps = (dlSizeBits / dlDurationSec) / 1_000_000;
                    
                    dlDisplay.textContent = dlSpeedMbps.toFixed(2);
                    dlDisplay.style.color = getSpeedColor(dlSpeedMbps);
                } catch(e) {
                    console.error("Erro no download:", e);
                    dlDisplay.textContent = "Erro";
                }

                // --- Teste de Upload ---
                status.textContent = "Testando Upload (2MB)...";
                ulDisplay.textContent = "...";
                try {
                    // Cria payload de 2MB
                    const ulData = new Uint8Array(2 * 1024 * 1024); 
                    const ulStart = performance.now();
                    await fetch('/api/speedtest/upload', {
                        method: 'POST',
                        body: ulData
                    });
                    const ulEnd = performance.now();
                    
                    const ulDurationSec = (ulEnd - ulStart) / 1000;
                    const ulSizeBits = ulData.length * 8;
                    const ulSpeedMbps = (ulSizeBits / ulDurationSec) / 1_000_000;
                    
                    ulDisplay.textContent = ulSpeedMbps.toFixed(2);
                    ulDisplay.style.color = getSpeedColor(ulSpeedMbps);
                } catch(e) {
                    console.error("Erro no upload:", e);
                    ulDisplay.textContent = "Erro";
                }

                status.innerHTML = `‚úÖ Teste conclu√≠do com sucesso!`;
            } else {
                latDisplay.textContent = "Erro";
                jitDisplay.textContent = "Erro";
                status.textContent = "‚ùå N√£o foi poss√≠vel conectar ao servidor.";
            }

            btn.disabled = false;
            btn.style.opacity = "1";
            btn.textContent = "üîÑ Refazer Teste";
        }

        function getSpeedColor(mbps) {
            if (mbps >= 20) return '#28a745'; // Verde (R√°pido)
            if (mbps >= 5) return '#ffc107';  // Amarelo (M√©dio)
            return '#dc3545';                 // Vermelho (Lento)
        }
    </script>

    <div class="card" style="margin-top: 20px;">
        <h3>üìö Entenda os Resultados</h3>
        <ul style="padding-left: 20px; line-height: 1.6;">
            <li style="margin-bottom: 10px;"><strong>Lat√™ncia (Ping):</strong> O tempo que um dado leva para ir do seu dispositivo at√© o servidor e voltar. Quanto menor, melhor (ideal < 50ms).</li>
            <li style="margin-bottom: 10px;"><strong>Jitter:</strong> A varia√ß√£o da lat√™ncia ao longo do tempo. Se oscilar muito, causa travamentos em chamadas de v√≠deo e jogos.</li>
            <li style="margin-bottom: 10px;"><strong>Taxa de Download:</strong> A velocidade de recebimento de dados (ex: carregar sites, assistir v√≠deos). Medido em Mbps.</li>
            <li style="margin-bottom: 10px;"><strong>Taxa de Upload:</strong> A velocidade de envio de dados (ex: enviar arquivos, transmitir sua c√¢mera). Medido em Mbps.</li>
        </ul>
    </div>

    <a href="{{ url_for('index') }}" class="back-link">‚Üê Voltar para Home</a>
{% endblock %}