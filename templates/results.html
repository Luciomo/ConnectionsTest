{% extends "base.html" %}

{% block title %}Resultados da An√°lise - VerificaSite{% endblock %}

{% block header %}
    <h1>Resultados da An√°lise üìä</h1>
    <p class="url-analisada"><strong>URL Analisada:</strong> {{ url }}</p>
{% endblock %}

{% block content %}
    <button id="btn-export-pdf" class="btn-pdf">üìÑ Baixar Relat√≥rio em PDF</button>

    <div id="pdf-content">
    <!-- Se√ß√£o VirusTotal -->
    {% if vt_result %}
            <div class="card report-vt">
                <h2>Relat√≥rio VirusTotal</h2>
                {% if vt_result.erro %}
                    <p class="error">‚ùå {{ vt_result.erro }}</p>
                {% elif vt_result.status %}
                     <p>‚ö™ {{ vt_result.status }}</p>
                {% else %}
                    <p><strong>Malicioso:</strong> <span class="malicious">{{ vt_result.malicioso }}</span></p>
                    <p><strong>Suspeito:</strong> <span class="suspicious">{{ vt_result.suspeito }}</span></p>
                    <p><strong>Seguro:</strong> <span class="safe">{{ vt_result.seguro }}</span></p>
                    <div class="summary">
                        {% if vt_result.malicioso > 0 or vt_result.suspeito > 0 %}
                            <strong>Resultado:</strong> <span class="malicious">PERIGOSO</span>
                        {% else %}
                            <strong>Resultado:</strong> <span class="safe">SEGURO</span>
                        {% endif %}
                    </div>
                {% endif %}
            </div>
            {% endif %}

            <!-- Se√ß√£o Google Safe Browsing -->
            {% if gsb_result %}
            <div class="card report-gsb">
                <h2>Relat√≥rio Google Safe Browsing</h2>
                {% if gsb_result.erro %}
                    <p class="error">‚ùå {{ gsb_result.erro }}</p>
                {% else %}
                    {% if gsb_result.status == 'Perigoso' %}
                        <p><strong>Amea√ßa:</strong> <span class="malicious">{{ gsb_result.amea√ßa }}</span></p>
                        <div class="summary">
                            <strong>Resultado:</strong> <span class="malicious">PERIGOSO</span>
                        </div>
                    {% else %}
                        <p><span class="safe">Nenhuma amea√ßa encontrada.</span></p>
                         <div class="summary">
                            <strong>Resultado:</strong> <span class="safe">SEGURO</span>
                        </div>
                    {% endif %}
                {% endif %}
            </div>
            {% endif %}

            <!-- Se√ß√£o WHOIS -->
            {% if whois_result %}
            <div class="card report-whois">
                <h2>Relat√≥rio WHOIS üîç</h2>
                {% if whois_result.erro %}
                    <p class="error">‚ùå {{ whois_result.erro }}</p>
                {% else %}
                    <ul>
                        {% for chave, valor in whois_result.items() %}
                            {# Exibe todos os campos que t√™m valor, exceto o texto bruto que vai separado #}
                            {% if valor and chave != 'raw_text' %}
                                <li><strong>{{ chave|replace('_', ' ')|title }}:</strong> {{ formatar_valor(valor) }}</li>
                            {% endif %}
                        {% endfor %}
                    </ul>
                    {% if whois_result.raw_text %}
                        <details>
                            <summary>üìú Ver Dados Brutos (Raw Text)</summary>
                            <pre>{{ whois_result.raw_text }}</pre>
                        </details>
                    {% endif %}
                {% endif %}
            </div>
            {% endif %}

            <!-- Se√ß√£o DNS -->
            {% if dns_result %}
            <div class="card report-dns">
                <h2>Relat√≥rio DNS üåê</h2>
                {% if dns_result.erro %}
                    <p class="error">‚ùå {{ dns_result.erro }}</p>
                {% elif dns_result %}
                    <div class="dns-records">
                        {% for tipo, registros in dns_result.items() %}
                            <div class="dns-group">
                                <h3>Registro {{ tipo }}</h3>
                                <ul>
                                    {% for reg in registros %}
                                        <li>{{ reg }}</li>
                                    {% endfor %}
                                </ul>
                            </div>
                        {% endfor %}
                    </div>
                {% else %}
                    <p>Nenhum registro DNS encontrado.</p>
                {% endif %}
            </div>
            {% endif %}

            <!-- Se√ß√£o Ping -->
            {% if ping_result %}
            <div class="card report-ping">
                <h2>Relat√≥rio de Lat√™ncia (Ping) üì∂</h2>
                {% if ping_result.erro %}
                    <p class="error">‚ùå {{ ping_result.erro }}</p>
                {% else %}
                    <pre>{{ ping_result.output }}</pre>
                {% endif %}
            </div>
            {% endif %}

            <!-- Se√ß√£o Tracert -->
            {% if tracert_result %}
            <div class="card report-tracert">
                <h2>Relat√≥rio de Rota (Tracert) üõ£Ô∏è</h2>
                {% if tracert_result.erro %}
                    <p class="error">‚ùå {{ tracert_result.erro }}</p>
                {% else %}
                    <pre>{{ tracert_result.output }}</pre>
                {% endif %}
            </div>
            {% endif %}

            <!-- Se√ß√£o Teste de Conex√£o -->
            {% if conn_result %}
            <div class="card report-connection">
                <h2>Relat√≥rio de Conex√£o üöÄ</h2>
                
                <div class="conn-grid">
                    <div class="conn-item">
                        <h3>Lat√™ncia (Ping)</h3>
                        {% if conn_result.latency_error %}
                            <span class="error">{{ conn_result.latency_error }}</span>
                        {% else %}
                            <span class="value">{{ "%.2f"|format(conn_result.avg_latency) }} ms</span>
                            <small>Jitter: {{ "%.2f"|format(conn_result.jitter) }} ms</small>
                        {% endif %}
                    </div>
                    
                    <div class="conn-item">
                        <h3>Velocidade</h3>
                        {% if conn_result.speedtest_error %}
                            <span class="error">{{ conn_result.speedtest_error }}</span>
                        {% else %}
                            <p>‚¨áÔ∏è Download: <strong>{{ "%.2f"|format(conn_result.download) }} Mbps</strong></p>
                            <p>‚¨ÜÔ∏è Upload: <strong>{{ "%.2f"|format(conn_result.upload) }} Mbps</strong></p>
                            <div style="position: relative; height:200px; width:100%">
                                <canvas id="speedChart"></canvas>
                            </div>
                            <script>
                            /*    document.addEventListener('DOMContentLoaded', function() {
                                    const ctx = document.getElementById('speedChart').getContext('2d');
                                    new Chart(ctx, {
                                        type: 'bar',
                                        data: {
                                            labels: ['Download', 'Upload'],
                                            datasets: [{
                                                label: 'Velocidade (Mbps)',
                                                data: [{{ conn_result.download }}, {{ conn_result.upload }}],
                                                backgroundColor: [
                                                    'rgba(54, 162, 235, 0.6)',
                                                    'rgba(75, 192, 192, 0.6)'
                                                ],
                                                borderColor: [
                                                    'rgba(54, 162, 235, 1)',
                                                    'rgba(75, 192, 192, 1)'
                                                ],
                                                borderWidth: 1
                                            }]
                                        },
                                        options: {
                                            responsive: true,
                                            maintainAspectRatio: false,
                                            scales: {
                                                y: {
                                                    beginAtZero: true
                                                }
                                            }
                                        }
                                    });
                                });*/
                            </script>
                        {% endif %}
                    </div>
                </div>
            </div>
            {% endif %}
    </div>

            <a href="{{ url_for('index') }}" class="back-link">Verificar outra URL</a>
{% endblock %}
